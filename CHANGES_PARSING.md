# Парсинг истории изменений филиалов Яндекс.Карт

## Описание

Система для сбора и анализа истории изменений филиалов на Яндекс.Картах.

## Структура данных

### BranchChange
Отдельное изменение филиала:
```typescript
{
  title: string;        // Название изменения: "Изменение адреса", "Добавление входов" и т.д.
  oldValue?: string;    // Старое значение (если есть)
  newValue?: string;    // Новое значение (если есть)
  timestamp: string;    // Время: "27-10-2025 · 02:29"
  author?: string;      // Автор: "ya.robot" и т.д.
}
```

### BranchChangeHistory
История изменений филиала:
```typescript
{
  branchId: string;           // ID филиала
  changesUrl: string;         // URL страницы изменений
  totalChanges: number;       // Общее количество изменений
  changes: BranchChange[];    // Массив всех изменений
}
```

## Использование

### 1. Сначала соберите список филиалов
```bash
npm run run:once
```
Это создаст `data/branches.json` с полями `changesUrl` для каждого филиала.

### 2. Соберите историю изменений
```bash
npm run fetch:changes
```
Это создаст `data/branches-changes.json` с историей изменений всех филиалов.

## Примеры данных

### Пример изменения адреса:
```json
{
  "title": "Изменение адреса",
  "oldValue": "Северо-Западный федеральный округ, Санкт-Петербург, Петродворцовый район, Ломоносов, Ораниенбаумский проспект, 41, корп. 1",
  "newValue": "Северо-Западный федеральный округ, Санкт-Петербург, Петродворцовый район, Ломоносов, Ораниенбаумский проспект, 41, корп. 1; этаж цокольный",
  "timestamp": "27-10-2025 · 02:29",
  "author": "ya.robot"
}
```

### Пример изменения координат:
```json
{
  "title": "Изменение координат",
  "oldValue": "[Прежнее положение на карте]",
  "newValue": "[Изменение на карте]",
  "timestamp": "18-05-2025 · 21:49",
  "author": "ya.robot"
}
```

### Пример добавления входов:
```json
{
  "title": "Добавление входов",
  "newValue": "[Изменение на карте]",
  "timestamp": "27-10-2025 · 02:29",
  "author": "ya.robot"
}
```

## Типы изменений

Система распознаёт следующие типы изменений:
- **Изменение адреса** - изменение текстового адреса
- **Изменение координат** - перемещение на карте
- **Добавление входов** - добавление точек входа на карте
- **Изменение названия** - изменение имени филиала
- **Изменение времени работы** - изменение графика
- И другие типы изменений, определяемые Яндексом

## Настройки

В файле `src/fetch-changes.ts` можно настроить:
- `limit = pLimit(3)` - количество одновременных запросов (по умолчанию 3)
- `BRANCHES_FILE` - путь к файлу с филиалами
- `CHANGES_OUTPUT_FILE` - путь для сохранения результатов

## Обработка ошибок

Система автоматически обрабатывает:
- SmartCaptcha (пропускает филиал с ошибкой)
- Требование повторной авторизации
- Таймауты загрузки страниц
- Отсутствие данных

## Статистика после сбора

После выполнения скрипт выводит:
- Общее количество изменений
- Количество филиалов с изменениями
- Топ-5 филиалов по количеству изменений
- Примеры найденных изменений

## Примечания

- Скрипт использует параллельную обработку (3 одновременных запроса)
- Для 185 филиалов обработка займёт около 10-15 минут
- Рекомендуется запускать с `BROWSER_HEADLESS=false` для отладки
- Все данные сохраняются в JSON формате для дальнейшей обработки

